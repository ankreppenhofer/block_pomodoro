define("block_pomodoro/pomodoro_timer",["core/ajax","core/notification"],(function(Ajax,Notification){let cfg=null,K=null,channel=null,intervalId=null;function clearTick(){null!==intervalId&&(clearInterval(intervalId),intervalId=null)}function alarm(){try{new window.Audio("/media/notification.mp3").play()}catch(e){window.navigator&&window.navigator.vibrate&&window.navigator.vibrate(200)}}function $(id){return document.getElementById(id)}function now(){return Date.now()}function readInt(v,d){const n=parseInt(null!=v?v:"",10);return Number.isFinite(n)?n:d}function formatTime(ms){const s=Math.max(0,Math.floor(ms/1e3)),m=Math.floor(s/60).toString().padStart(2,"0"),r=(s%60).toString().padStart(2,"0");return"".concat(m,":").concat(r)}function renderTomatoes(el,sessionscount,interval){if(!el)return;const n=Math.max(0,Number(sessionscount)||0),m=Math.max(1,Number(interval)||0),filled=n%m==0&&0!==n?m:n%m;el.innerHTML=Array.from({length:m},((_,i)=>'<span class="tomato '.concat(i<filled?"filled":"",'" aria-hidden="true"></span>'))).join("")}function openDialog(d){d&&"function"==typeof d.showModal&&d.showModal()}function closeDialog(d){d&&d.open&&d.close()}function startTimer(endTs,el,onDone){if(!el||!Number.isFinite(endTs))return;if(endTs<=now())return localStorage.removeItem(K.END),void localStorage.setItem(K.RUNNING,"0");clearTick();const tick=()=>{const left=endTs-now();if(left<=0)return clearTick(),el.textContent="00:00",localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"),sendMessage({type:"stopped"}),void(onDone&&onDone());el.textContent=formatTime(left)};tick(),intervalId=setInterval(tick,1e3)}function stopAndReset(el){let play=arguments.length>1&&void 0!==arguments[1]&&arguments[1];clearTick(),localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"),sendMessage({type:"stopped"}),el&&(el.textContent="00:00"),play&&alarm()}function startFocus(el,ms){if(!cfg)return;const focusDur=Number.isFinite(ms)&&ms>0?ms:15e5;setPhase("focus");const starttsSec=Math.floor(now()/1e3),end=now()+focusDur;localStorage.setItem(K.END,String(end)),localStorage.setItem(K.RUNNING,"1"),sendMessage({type:"start",end:end}),startTimer(end,el,(()=>{ajax("block_pomodoro_increment_session",{courseid:cfg.courseid,startts:starttsSec}).then((res=>{alarm();const count=res&&"number"==typeof res.sessionscount?res.sessionscount:1;renderTomatoes($("pomodoro-tomatoes"),count,cfg.longbreakInterval);const isLong=(c=count,(i=cfg.longbreakInterval)>0&&c>0&&c%i==0);var c,i;return function(el,ms,kind){setPhase("break",kind);const dlg=$("break-modal"),cd=$("break-countdown");cd&&(cd.textContent=formatTime(ms)),openDialog(dlg),startTimer(now()+ms,cd||el,(()=>{alarm(),closeDialog(dlg),stopAndReset(el,!1)}));const ok=$("dismiss-break");ok&&(ok.type="button",ok.onclick=e=>{e.preventDefault(),e.stopPropagation(),closeDialog(dlg)})}(el,isLong?cfg.longbreakMs:cfg.shortbreakMs,isLong?"long":"short"),null})).catch(Notification.exception)}))}function setPhase(p,k){localStorage.setItem(K.PHASE,p),k?localStorage.setItem(K.BREAKKIND,k):localStorage.removeItem(K.BREAKKIND)}function sendMessage(msg){channel?channel.postMessage(msg):(localStorage.setItem(K.MSG,JSON.stringify(Object.assign({},msg,{t:now()}))),setTimeout((function(){localStorage.removeItem(K.MSG)}),50))}function handleMessage(msg,el){if(msg)return"start"===msg.type&&msg.end?(startTimer(Number(msg.end),el),localStorage.setItem(K.END,String(msg.end)),void localStorage.setItem(K.RUNNING,"1")):void("stop"!==msg.type&&"stopped"!==msg.type||!localStorage.getItem(K.END)||stopAndReset(el,!1))}function ajax(name,args){return Ajax.call([{methodname:name,args:args}])[0].catch(Notification.exception)}return{init(){const display=$("pomodoro-timer-display");if(!display)return;cfg=function(timerDisplay){const courseid=readInt(timerDisplay.getAttribute("data-courseid"),0),wellnessSec=readInt(timerDisplay.getAttribute("data-wellness-sec"),30);let focusMs;const focusSec=readInt(timerDisplay.getAttribute("data-focus-sec"),NaN);if(Number.isFinite(focusSec))focusMs=1e3*focusSec;else{let focusMin=readInt(timerDisplay.getAttribute("data-focus-min"),NaN);Number.isFinite(focusMin)||(focusMin=readInt((timerDisplay.getAttribute("data-duration")||"25:00").split(":")[0]||"25",25)),focusMs=60*focusMin*1e3}let shortbreakMs,longbreakMs;const sbSec=readInt(timerDisplay.getAttribute("data-shortbreak-sec"),NaN),lbSec=readInt(timerDisplay.getAttribute("data-longbreak-sec"),NaN);return Number.isFinite(sbSec)&&(shortbreakMs=1e3*sbSec),Number.isFinite(lbSec)&&(longbreakMs=1e3*lbSec),Number.isFinite(shortbreakMs)||(shortbreakMs=60*readInt(timerDisplay.getAttribute("data-shortbreak-min"),5)*1e3),Number.isFinite(longbreakMs)||(longbreakMs=60*readInt(timerDisplay.getAttribute("data-longbreak-min"),15)*1e3),{courseid:courseid,wellnessSec:wellnessSec,focusMs:focusMs,shortbreakMs:shortbreakMs,longbreakMs:longbreakMs,longbreakInterval:readInt(timerDisplay.getAttribute("data-longbreak-interval"),3)}}(display),K=function(courseid){const cid=Number.isFinite(courseid)&&courseid>0?courseid:"global",p="pomodoro:".concat(cid);return{END:"".concat(p,":endTimestamp"),RUNNING:"".concat(p,":running"),PHASE:"".concat(p,":phase"),BREAKKIND:"".concat(p,":breakKind"),MSG:"".concat(p,":msg"),CHANNEL:"".concat(p,":channel")}}(cfg.courseid);const intervalEl=$("pomodoro-interval");intervalEl&&(intervalEl.textContent=String(cfg.longbreakInterval)),"undefined"!=typeof BroadcastChannel&&(channel=new BroadcastChannel(K.CHANNEL),channel.onmessage=e=>handleMessage(e.data,display)),ajax("block_pomodoro_get_status",{courseid:cfg.courseid}).then((res=>{const count=res&&"number"==typeof res.sessionscount?res.sessionscount:0;return renderTomatoes($("pomodoro-tomatoes"),count,cfg.longbreakInterval),null})).catch(Notification.exception);const existingRaw=localStorage.getItem(K.END);if(null!==existingRaw){const existing=Number(existingRaw),phase=localStorage.getItem(K.PHASE)||"";let target;target="wellness"===phase?$("wellness-countdown"):"break"===phase?$("break-countdown"):display,Number.isFinite(existing)&&existing>now()+250?("break"===phase&&openDialog($("break-modal")),"wellness"===phase&&openDialog($("wellness-modal")),startTimer(existing,target||display)):(localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"))}window.addEventListener("storage",(e=>{if(e.key!==K.END){if(e.key===K.MSG&&e.newValue)try{handleMessage(JSON.parse(e.newValue),display)}catch(err){}}else if(null!==e.newValue){const val=Number(e.newValue);Number.isFinite(val)&&val>now()+250?startTimer(val,display):(localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"))}else localStorage.setItem(K.RUNNING,"0")}));const startBtn=$("start");startBtn&&(startBtn.type="button",startBtn.onclick=e=>{e.preventDefault(),e.stopPropagation(),function(onAfter){setPhase("wellness");const dlg=$("wellness-modal"),cd=$("wellness-countdown");if(!cfg)return;if(!dlg||!cd)return void onAfter();const end=now()+1e3*cfg.wellnessSec;openDialog(dlg),startTimer(end,cd,(()=>{closeDialog(dlg),onAfter()}));const skip=$("skip-wellness");skip&&(skip.type="button",skip.onclick=e=>{e.preventDefault(),e.stopPropagation(),closeDialog(dlg),onAfter()})}((()=>startFocus(display,cfg.focusMs)))});const stopBtn=$("stop");stopBtn&&(stopBtn.type="button",stopBtn.onclick=e=>{e.preventDefault(),e.stopPropagation(),stopAndReset(display,!1)}),window.addEventListener("beforeunload",(()=>{channel&&channel.close()}))}}}));

//# sourceMappingURL=pomodoro_timer.min.js.map