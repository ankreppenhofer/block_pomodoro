define("block_pomodoro/pomodoro_timer",["exports"],(function(_exports){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;_exports.init=()=>{const STORAGE_KEY="pomodoro:endTimestamp",RUNNING_KEY="pomodoro:running",pomodoroTimerDisplay=document.getElementById("pomodoro-timer-display");let myInterval=null,broadcast=null;function sendMessage(msg){broadcast?broadcast.postMessage(msg):(localStorage.setItem("pomodoro:msg",JSON.stringify({...msg,t:Date.now()})),setTimeout((()=>localStorage.removeItem("pomodoro:msg")),50))}function stopAndResetTimerDisplay(timerDisplayElement){let playAlarm=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(myInterval&&(clearInterval(myInterval),myInterval=null),localStorage.removeItem(STORAGE_KEY),localStorage.setItem(RUNNING_KEY,"0"),sendMessage({type:"stopped"}),timerDisplayElement&&(timerDisplayElement.textContent="00:00"),playAlarm)try{new Audio("https://www.freespecialeffects.co.uk/soundfx/scifi/electronic.wav").play().catch((()=>{}))}catch(e){}}function startLocalTimer(endTimestamp,timerDisplayElement){function tick(){const msRemaining=endTimestamp-Date.now();msRemaining<=0?stopAndResetTimerDisplay(timerDisplayElement,!0):timerDisplayElement.textContent=function(ms){const totalSeconds=Math.max(0,Math.floor(ms/1e3)),minutes=Math.floor(totalSeconds/60).toString().padStart(2,"0"),seconds=(totalSeconds%60).toString().padStart(2,"0");return"".concat(minutes,":").concat(seconds)}(msRemaining)}timerDisplayElement&&(myInterval&&clearInterval(myInterval),tick(),myInterval=setInterval(tick,1e3))}function handleMessage(msg){msg&&("start"===msg.type&&msg.end?(startLocalTimer(Number(msg.end),pomodoroTimerDisplay),localStorage.setItem(STORAGE_KEY,String(msg.end)),localStorage.setItem(RUNNING_KEY,"1")):"stop"!==msg.type&&"stopped"!==msg.type||(myInterval&&(clearInterval(myInterval),myInterval=null),pomodoroTimerDisplay&&(pomodoroTimerDisplay.textContent="00:00"),localStorage.removeItem(STORAGE_KEY),localStorage.setItem(RUNNING_KEY,"0")))}"undefined"!=typeof BroadcastChannel&&(broadcast=new BroadcastChannel("pomodoro"),broadcast.onmessage=ev=>handleMessage(ev.data)),window.addEventListener("storage",(e=>{if(e.key===STORAGE_KEY)e.newValue?startLocalTimer(Number(e.newValue),pomodoroTimerDisplay):(myInterval&&(clearInterval(myInterval),myInterval=null),pomodoroTimerDisplay&&(pomodoroTimerDisplay.textContent="00:00"));else if(e.key===RUNNING_KEY);else if("pomodoro:msg"===e.key&&e.newValue)try{handleMessage(JSON.parse(e.newValue))}catch(err){}}));const existing=localStorage.getItem(STORAGE_KEY);existing&&startLocalTimer(Number(existing),pomodoroTimerDisplay),document.getElementById("start").addEventListener("click",(function(){!function(timerdisplay){if(!timerdisplay)return;myInterval&&clearInterval(myInterval);const durationAttr=timerdisplay.getAttribute("data-duration")||"25:00",durationMs=60*(parseInt(durationAttr.split(":")[0],10)||25)*1e3,endTimestamp=Date.now()+durationMs;localStorage.setItem(STORAGE_KEY,String(endTimestamp)),localStorage.setItem(RUNNING_KEY,"1"),sendMessage({type:"start",end:endTimestamp}),startLocalTimer(endTimestamp,timerdisplay)}(pomodoroTimerDisplay)})),document.getElementById("stop").addEventListener("click",(function(){stopAndResetTimerDisplay(pomodoroTimerDisplay,!1)})),window.addEventListener("beforeunload",(()=>{broadcast&&broadcast.close()}))}}));

//# sourceMappingURL=pomodoro_timer.min.js.map