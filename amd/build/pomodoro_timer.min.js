define("block_pomodoro/pomodoro_timer",["core/ajax","core/notification"],function(Ajax,Notification){const $=id=>document.getElementById(id),now=()=>Date.now(),readInt=(v,d)=>{const n=parseInt(v??"",10);return Number.isFinite(n)?n:d},fmt=ms=>{const s=Math.max(0,Math.floor(ms/1e3));return`${Math.floor(s/60).toString().padStart(2,"0")}:${(s%60).toString().padStart(2,"0")}`},renderTomatoes=(el,sessionscount,interval)=>{if(!el)return;const n=Math.max(0,0|sessionscount),m=Math.max(1,0|interval),filled=n%m===0&&0!==n?m:n%m,items=Array.from({length:m},(_,i)=>`<span class="tomato ${i<filled?"filled":""}" aria-hidden="true"></span>`).join("");el.innerHTML=items};return{init(){const display=$("pomodoro-timer-display");if(!display)return;const courseid=readInt(display.getAttribute("data-courseid"),0),K=(courseid=>{const p=`pomodoro:${Number.isFinite(courseid)&&courseid>0?courseid:"global"}`;return{END:`${p}:endTimestamp`,RUNNING:`${p}:running`,PHASE:`${p}:phase`,BREAKKIND:`${p}:breakKind`,MSG:`${p}:msg`,CHANNEL:`${p}:channel`}})(courseid),wellnessSec=readInt(display.getAttribute("data-wellness-sec"),30);let focusMs;const focusSec=readInt(display.getAttribute("data-focus-sec"),NaN);if(Number.isFinite(focusSec))focusMs=1e3*focusSec;else{let focusMin=readInt(display.getAttribute("data-focus-min"),NaN);if(!Number.isFinite(focusMin)){const dur=display.getAttribute("data-duration")||"25:00",[mm="25"]=dur.split(":");focusMin=readInt(mm,25)}focusMs=60*focusMin*1e3}let shortbreakMs,longbreakMs;const sbSec=readInt(display.getAttribute("data-shortbreak-sec"),NaN),lbSec=readInt(display.getAttribute("data-longbreak-sec"),NaN);Number.isFinite(sbSec)&&(shortbreakMs=1e3*sbSec),Number.isFinite(lbSec)&&(longbreakMs=1e3*lbSec),Number.isFinite(shortbreakMs)||(shortbreakMs=60*readInt(display.getAttribute("data-shortbreak-min"),5)*1e3),Number.isFinite(longbreakMs)||(longbreakMs=60*readInt(display.getAttribute("data-longbreak-min"),15)*1e3);const longbreakInterval=readInt(display.getAttribute("data-longbreak-interval"),3),cfg={courseid:courseid,wellnessSec:wellnessSec,focusMs:focusMs,shortbreakMs:shortbreakMs,longbreakMs:longbreakMs,longbreakInterval:longbreakInterval},intervalEl=$("pomodoro-interval");intervalEl&&(intervalEl.textContent=String(longbreakInterval));let intervalId=null,channel=null;const sendMessage=msg=>{channel?channel.postMessage(msg):(localStorage.setItem(K.MSG,JSON.stringify({...msg,t:now()})),setTimeout(()=>localStorage.removeItem(K.MSG),50))},clearTick=()=>{intervalId&&(clearInterval(intervalId),intervalId=null)},alarm=()=>{try{new Audio("https://www.freespecialeffects.co.uk/soundfx/scifi/electronic.wav").play().catch(()=>{})}catch{}},setPhase=(p,k)=>{localStorage.setItem(K.PHASE,p),k?localStorage.setItem(K.BREAKKIND,k):localStorage.removeItem(K.BREAKKIND)},ajax=(name,args)=>Ajax.call([{methodname:name,args:args}])[0].catch(Notification.exception),startLocalTimer=(endTs,el,onDone)=>{if(!el||!Number.isFinite(endTs))return;if(endTs<=now())return localStorage.removeItem(K.END),void localStorage.setItem(K.RUNNING,"0");clearTick();const tick=()=>{const left=endTs-now();if(left<=0)return clearTick(),el.textContent="00:00",localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"),sendMessage({type:"stopped"}),void(onDone&&onDone());el.textContent=fmt(left)};tick(),intervalId=setInterval(tick,1e3)},stopAndReset=function(el){let play=arguments.length>1&&void 0!==arguments[1]&&arguments[1];clearTick(),localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"),sendMessage({type:"stopped"}),el&&(el.textContent="00:00"),play&&alarm()},handleMessage=(msg,el)=>{if(msg)return"start"===msg.type&&msg.end?(startLocalTimer(Number(msg.end),el),localStorage.setItem(K.END,String(msg.end)),void localStorage.setItem(K.RUNNING,"1")):void("stop"!==msg.type&&"stopped"!==msg.type||localStorage.getItem(K.END)&&stopAndReset(el,!1))},openDlg=d=>{d&&"function"==typeof d.showModal&&d.showModal()},closeDlg=d=>{d&&d.open&&d.close()},startFocus=(el,ms)=>{const focusDur=Number.isFinite(ms)&&ms>0?ms:15e5;setPhase("focus");const starttsSec=Math.floor(now()/1e3),end=now()+focusDur;localStorage.setItem(K.END,String(end)),localStorage.setItem(K.RUNNING,"1"),sendMessage({type:"start",end:end}),startLocalTimer(end,el,()=>{ajax("block_pomodoro_increment_session",{courseid:cfg.courseid,startts:starttsSec}).then(res=>{alarm();const count=res&&"number"==typeof res.sessionscount?res.sessionscount:1;renderTomatoes($("pomodoro-tomatoes"),count,cfg.longbreakInterval);const isLong=(c=count,(i=cfg.longbreakInterval)>0&&c>0&&c%i===0);var c,i;((el,ms,kind)=>{setPhase("break",kind);const dlg=$("break-modal"),cd=$("break-countdown");cd&&(cd.textContent=fmt(ms)),openDlg(dlg);const end=now()+ms;startLocalTimer(end,cd||el,()=>{alarm(),closeDlg(dlg),stopAndReset(el,!1)});const ok=$("dismiss-break");ok&&(ok.type="button",ok.onclick=e=>{e.preventDefault(),e.stopPropagation(),closeDlg(dlg)})})(el,isLong?cfg.longbreakMs:cfg.shortbreakMs,isLong?"long":"short")})})};"undefined"!=typeof BroadcastChannel&&(channel=new BroadcastChannel(K.CHANNEL),channel.onmessage=e=>handleMessage(e.data,display)),ajax("block_pomodoro_get_status",{courseid:cfg.courseid}).then(res=>{const count=res&&"number"==typeof res.sessionscount?res.sessionscount:0;renderTomatoes($("pomodoro-tomatoes"),count,cfg.longbreakInterval)});const existingRaw=localStorage.getItem(K.END);if(null!==existingRaw){const existing=Number(existingRaw),phase=localStorage.getItem(K.PHASE)||"",target="wellness"===phase?$("wellness-countdown"):"break"===phase?$("break-countdown"):display;Number.isFinite(existing)&&existing>now()+250?("break"===phase&&openDlg($("break-modal")),"wellness"===phase&&openDlg($("wellness-modal")),startLocalTimer(existing,target||display)):(localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"))}window.addEventListener("storage",e=>{if(e.key!==K.END){if(e.key===K.MSG&&e.newValue)try{handleMessage(JSON.parse(e.newValue),display)}catch{}}else if(null!==e.newValue){const val=Number(e.newValue);Number.isFinite(val)&&val>now()+250?startLocalTimer(val,display):(localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"))}else localStorage.setItem(K.RUNNING,"0")});const startBtn=$("start");startBtn&&(startBtn.type="button",startBtn.onclick=e=>{e.preventDefault(),e.stopPropagation(),(onAfter=>{setPhase("wellness");const dlg=$("wellness-modal"),cd=$("wellness-countdown");if(!dlg||!cd)return void onAfter();const end=now()+1e3*cfg.wellnessSec;openDlg(dlg),startLocalTimer(end,cd,()=>{closeDlg(dlg),onAfter()});const skip=$("skip-wellness");skip&&(skip.type="button",skip.onclick=e=>{e.preventDefault(),e.stopPropagation(),closeDlg(dlg),onAfter()})})(()=>startFocus(display,cfg.focusMs))});const stopBtn=$("stop");stopBtn&&(stopBtn.type="button",stopBtn.onclick=e=>{e.preventDefault(),e.stopPropagation(),stopAndReset(display,!1)}),window.addEventListener("beforeunload",()=>{channel&&channel.close()})}}});

//# sourceMappingURL=pomodoro_timer.min.js.map