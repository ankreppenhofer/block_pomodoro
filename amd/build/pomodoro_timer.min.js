<<<<<<< HEAD
define("block_pomodoro/pomodoro_timer",["core/ajax","core/notification"],(function(Ajax,Notification){let cfg=null,K=null,channel=null,intervalId=null;function clearTick(){null!==intervalId&&(clearInterval(intervalId),intervalId=null)}function alarm(){let kind=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";try{const soundUrl="".concat(M.cfg.wwwroot,"click"===kind?"/blocks/pomodoro/sounds/press.mp3":"/blocks/pomodoro/sounds/alert.mp3");new Audio(soundUrl).play().catch((()=>{navigator.vibrate&&navigator.vibrate(200)}))}catch{navigator.vibrate&&navigator.vibrate(200)}}function $(id){return document.getElementById(id)}function now(){return Date.now()}function readInt(v,d){const n=parseInt(null!=v?v:"",10);return Number.isFinite(n)?n:d}function formatTime(ms){const s=Math.max(0,Math.floor(ms/1e3)),m=Math.floor(s/60).toString().padStart(2,"0"),r=(s%60).toString().padStart(2,"0");return"".concat(m,":").concat(r)}function getTimerElement(){return $("pomodoro-timer-display")}function renderTomatoes(el,sessionscount,interval){if(!el)return;const n=Math.max(0,Number(sessionscount)||0),m=Math.max(1,Number(interval)||0),filled=n%m==0&&0!==n?m:n%m;el.innerHTML=Array.from({length:m},((_,i)=>i<filled?'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="25" height="25" \n                style="vertical-align:middle; margin-right:6px;">\n                <polygon style="fill:#AB2300;" points="512,155.826 478.609,155.826 ..."/>\n               <polygon style="fill:#AB2300;" points="512,155.826 478.609,155.826 478.609,100.174 445.217,100.174 445.217,66.783 \n                    411.826,66.783 411.826,33.391 300.522,33.391 300.522,66.783 267.13,66.783 267.13,0 233.739,0 233.739,66.783 211.478,66.783 \n                    211.478,33.391 100.174,33.391 100.174,66.783 66.783,66.783 66.783,100.174 33.391,100.174 33.391,155.826 0,155.826 0,345.043 \n                    33.391,345.043 33.391,411.826 66.783,411.826 66.783,445.217 100.174,445.217 100.174,478.609 166.957,478.609 166.957,512 \n                    345.043,512 345.043,478.609 411.826,478.609 411.826,445.217 445.217,445.217 445.217,411.826 478.609,411.826 478.609,345.043 \n                    512,345.043 "/>\n                <polygon style="fill:#4E901E;" points="445.217,100.174 445.217,66.783 411.826,66.783 411.826,33.391 300.522,33.391 \n                    300.522,66.783 289.391,66.783 267.13,66.783 267.13,0 233.739,0 233.739,66.783 222.609,66.783 211.478,66.783 211.478,33.391 \n                    100.174,33.391 100.174,66.783 66.783,66.783 66.783,100.174 33.391,100.174 33.391,155.826 66.783,155.826 133.565,155.826 \n                    133.565,222.609 222.609,222.609 222.609,189.217 289.391,189.217 289.391,222.609 378.435,222.609 378.435,155.826 \n                    445.217,155.826 478.609,155.826 478.609,100.174 "/>\n                <polygon points="233.739,100.174 233.739,122.435 267.13,122.435 267.13,100.174 300.522,100.174 300.522,66.783 267.13,66.783 \n                    267.13,0 233.739,0 233.739,66.783 211.478,66.783 211.478,100.174 "/>\n                <rect x="222.609" y="155.826" width="66.783" height="33.391"/>\n                <polygon points="378.435,122.435 345.043,122.435 345.043,155.826 345.043,189.217 289.391,189.217 289.391,222.609 \n                    345.043,222.609 378.435,222.609 378.435,189.217 378.435,155.826 445.217,155.826 478.609,155.826 478.609,122.435 \n                    478.609,100.174 445.217,100.174 445.217,122.435 "/>\n                <rect x="411.826" y="66.783" width="33.391" height="33.391"/>\n                <rect x="300.522" y="33.391" width="111.304" height="33.391"/>\n                <rect x="100.174" y="33.391" width="111.304" height="33.391"/>\n                <rect x="66.783" y="66.783" width="33.391" height="33.391"/>\n                <polygon points="133.565,155.826 133.565,189.217 133.565,222.609 166.957,222.609 222.609,222.609 222.609,189.217 \n                    166.957,189.217 166.957,155.826 166.957,122.435 133.565,122.435 66.783,122.435 66.783,100.174 33.391,100.174 33.391,122.435 \n                    33.391,155.826 66.783,155.826 "/>\n                <rect x="33.391" y="345.043" width="33.391" height="66.783"/>\n                <rect x="66.783" y="411.826" width="33.391" height="33.391"/>\n                <rect x="100.174" y="445.217" width="66.783" height="33.391"/>\n                <rect x="166.957" y="478.609" width="178.087" height="33.391"/>\n                <rect x="345.043" y="445.217" width="66.783" height="33.391"/>\n                <rect x="411.826" y="411.826" width="33.391" height="33.391"/>\n                <rect x="445.217" y="345.043" width="33.391" height="66.783"/>\n                <rect x="478.609" y="155.826" width="33.391" height="189.217"/>\n                <rect y="155.826" width="33.391" height="189.217"/>\n                <g>\n                    <rect x="66.783" y="189.217" style="fill:#FFFFFF;" width="33.391" height="55.652"/>\n                    <rect x="66.783" y="278.261" style="fill:#FFFFFF;" width="33.391" height="33.391"/>\n                </g>\n            </svg>':'<span class="tomato" aria-hidden="true"></span>')).join("")}function openDialog(d){d&&"function"==typeof d.showModal&&d.showModal()}function closeDialog(d){d&&d.open&&d.close()}function startTimer(endTs,el,onDone){const playButton=document.getElementById("start"),pauseButton=document.getElementById("pause");if(!el||!Number.isFinite(endTs))return;if(endTs<=now())return localStorage.removeItem(K.END),void localStorage.setItem(K.RUNNING,"0");clearTick();const tick=()=>{const left=endTs-now();if(left<=0)return clearTick(),el.textContent="00:00",localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"),sendMessage({type:"stop"}),void(onDone&&onDone());el.textContent=formatTime(left)};tick(),intervalId=setInterval(tick,1e3),playButton.classList.add("hidden"),pauseButton.classList.remove("hidden")}function stopAndReset(el){let play=arguments.length>1&&void 0!==arguments[1]&&arguments[1];document.getElementById("start"),document.getElementById("pause");clearTick(),localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"),sendMessage({type:"stop"}),el&&(el.textContent=formatTime(cfg.focusMs)),play&&alarm()}function startPausePomodoro(onAfter){if(!cfg)return;const display=getTimerElement();if(!display)return;const remainRaw=localStorage.getItem(K.REMAINING),running="1"===localStorage.getItem(K.RUNNING),endRaw=localStorage.getItem(K.END);if(null===remainRaw)if(running){if(null!==endRaw){const left=Number(endRaw)-now();if(left>0){localStorage.setItem(K.REMAINING,String(left)),sendMessage({type:"pause",remaining:left}),display&&(display.textContent=formatTime(left));const playButton=document.getElementById("start");document.getElementById("pause").classList.add("hidden"),playButton.classList.remove("hidden")}}clearTick(),localStorage.setItem(K.RUNNING,"0")}else!function(onAfter){setPhase("wellness");const modal=$("wellness-modal"),countdown=$("wellness-countdown");if(!cfg)return;if(!modal||!countdown)return void onAfter();const end=now()+1e3*cfg.wellnessSec;openDialog(modal),startTimer(end,countdown,(()=>{closeDialog(modal),onAfter()}));const skip=$("skip-wellness");skip&&(skip.type="button",skip.onclick=e=>{alarm("click"),e.preventDefault(),e.stopPropagation(),closeDialog(modal),onAfter()})}(onAfter);else{const remain=Number(remainRaw);Number.isFinite(remain)&&remain>0&&(localStorage.removeItem(K.REMAINING),startFocus(display,remain))}}function startFocus(el,ms){if(!cfg)return;const focusDur=Number.isFinite(ms)&&ms>0?ms:15e5;setPhase("focus");const starttsSec=Math.floor(now()/1e3),end=now()+focusDur;localStorage.setItem(K.END,String(end)),localStorage.setItem(K.RUNNING,"1"),sendMessage({type:"start",end:end}),startTimer(end,el,(()=>{ajax("block_pomodoro_increment_session",{courseid:cfg.courseid,startts:starttsSec}).then((res=>{alarm();const count=res&&"number"==typeof res.sessionscount?res.sessionscount:1;renderTomatoes($("pomodoro-tomatoes"),count,cfg.longbreakInterval);const isLong=(c=count,(i=cfg.longbreakInterval)>0&&c>0&&c%i==0);var c,i;!function(el,ms,kind){setPhase("break",kind);const dlg=$("break-modal"),cd=$("break-countdown");cd&&(cd.textContent=formatTime(ms)),openDialog(dlg),startTimer(now()+ms,cd||el,(()=>{alarm("focus"),closeDialog(dlg),stopAndReset(el,!1)}));const ok=$("dismiss-break");ok&&(ok.type="button",ok.onclick=e=>{alarm("click"),e.preventDefault(),e.stopPropagation(),closeDialog(dlg)})}(el,isLong?cfg.longbreakMs:cfg.shortbreakMs,isLong?"long":"short");const playButton=document.getElementById("start");return document.getElementById("pause").classList.add("hidden"),playButton.classList.remove("hidden"),null})).catch(Notification.exception)}))}function setPhase(p,k){localStorage.setItem(K.PHASE,p),k?localStorage.setItem(K.BREAKKIND,k):localStorage.removeItem(K.BREAKKIND)}function sendMessage(msg){channel?channel.postMessage(msg):(localStorage.setItem(K.MSG,JSON.stringify(Object.assign({},msg,{t:now()}))),setTimeout((function(){localStorage.removeItem(K.MSG)}),50))}function handleMessage(msg,el){if(msg)return"start"===msg.type&&msg.end?(startTimer(Number(msg.end),el),localStorage.setItem(K.END,String(msg.end)),void localStorage.setItem(K.RUNNING,"1")):"pause"===msg.type&&void 0!==msg.remaining?(clearTick(),localStorage.setItem(K.REMAINING,String(msg.remaining)),localStorage.setItem(K.RUNNING,"0"),void(el&&(el.textContent=formatTime(msg.remaining)))):void("stop"===msg.type&&localStorage.getItem(K.END)&&stopAndReset(el,!1))}function ajax(name,args){return Ajax.call([{methodname:name,args:args}])[0].catch(Notification.exception)}return{init(){const display=getTimerElement();if(!display)return;cfg=function(timerDisplay){const courseid=readInt(timerDisplay.getAttribute("data-courseid"),0),wellnessSec=readInt(timerDisplay.getAttribute("data-wellness-sec"),30);let focusMs;const focusSec=readInt(timerDisplay.getAttribute("data-focus-sec"),NaN);if(Number.isFinite(focusSec))focusMs=1e3*focusSec;else{let focusMin=readInt(timerDisplay.getAttribute("data-focus-min"),NaN);Number.isFinite(focusMin)||(focusMin=readInt((timerDisplay.getAttribute("data-duration")||"25:00").split(":")[0]||"25",25)),focusMs=60*focusMin*1e3}let shortbreakMs,longbreakMs;const sbSec=readInt(timerDisplay.getAttribute("data-shortbreak-sec"),NaN),lbSec=readInt(timerDisplay.getAttribute("data-longbreak-sec"),NaN);return Number.isFinite(sbSec)&&(shortbreakMs=1e3*sbSec),Number.isFinite(lbSec)&&(longbreakMs=1e3*lbSec),Number.isFinite(shortbreakMs)||(shortbreakMs=60*readInt(timerDisplay.getAttribute("data-shortbreak-min"),5)*1e3),Number.isFinite(longbreakMs)||(longbreakMs=60*readInt(timerDisplay.getAttribute("data-longbreak-min"),15)*1e3),{courseid:courseid,wellnessSec:wellnessSec,focusMs:focusMs,shortbreakMs:shortbreakMs,longbreakMs:longbreakMs,longbreakInterval:readInt(timerDisplay.getAttribute("data-longbreak-interval"),3)}}(display),K=function(courseid){const cid=Number.isFinite(courseid)&&courseid>0?courseid:"global",p="pomodoro:".concat(cid);return{END:"".concat(p,":endTimestamp"),RUNNING:"".concat(p,":running"),PHASE:"".concat(p,":phase"),BREAKKIND:"".concat(p,":breakKind"),MSG:"".concat(p,":msg"),CHANNEL:"".concat(p,":channel")}}(cfg.courseid);const intervalEl=$("pomodoro-interval");intervalEl&&(intervalEl.textContent=String(cfg.longbreakInterval)),"undefined"!=typeof BroadcastChannel&&(channel=new BroadcastChannel(K.CHANNEL),channel.onmessage=e=>handleMessage(e.data,display)),ajax("block_pomodoro_get_status",{courseid:cfg.courseid}).then((res=>{const count=res&&"number"==typeof res.sessionscount?res.sessionscount:0;return renderTomatoes($("pomodoro-tomatoes"),count,cfg.longbreakInterval),null})).catch(Notification.exception);const existingRaw=localStorage.getItem(K.END);if(null!==existingRaw){const existing=Number(existingRaw),phase=localStorage.getItem(K.PHASE)||"";let target;target="wellness"===phase?$("wellness-countdown"):"break"===phase?$("break-countdown"):display,Number.isFinite(existing)&&existing>now()+250?("break"===phase&&openDialog($("break-modal")),"wellness"===phase&&openDialog($("wellness-modal")),startTimer(existing,target||display)):(localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"))}window.addEventListener("storage",(e=>{if(e.key!==K.END){if(e.key===K.MSG&&e.newValue)try{handleMessage(JSON.parse(e.newValue),display)}catch(err){window&&window.console&&"function"==typeof window.console.debug&&window.console.debug("Pomodoro: storage MSG parse ignored",err)}}else if(null!==e.newValue){const val=Number(e.newValue);Number.isFinite(val)&&val>now()+250?startTimer(val,display):(localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"))}else localStorage.setItem(K.RUNNING,"0")}));const startBtn=$("start");startBtn&&(startBtn.type="button",startBtn.onclick=e=>{alarm("click"),e.preventDefault(),e.stopPropagation(),startPausePomodoro((()=>startFocus(display,cfg.focusMs)))});const pauseBtn=$("pause");pauseBtn&&(pauseBtn.type="button",pauseBtn.onclick=e=>{alarm("click"),e.preventDefault(),e.stopPropagation(),startPausePomodoro(null)});const resetBtn=$("reset");resetBtn&&(resetBtn.type="button",resetBtn.onclick=e=>{alarm("click"),e.preventDefault(),e.stopPropagation(),stopAndReset(display,!1)}),window.addEventListener("beforeunload",(()=>{channel&&channel.close()}))}}}));
=======
define("block_pomodoro/pomodoro_timer",["core/ajax","core/notification"],(function(Ajax,Notification){let cfg=null,K=null,channel=null,intervalId=null;let currentFrame=1,growInterval=null,plantImg=null;let state="stopped";function clearTick(){null!==intervalId&&(clearInterval(intervalId),intervalId=null)}function alarm(){let kind=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";try{var soundUrl;soundUrl="click"===kind?M.cfg.wwwroot+"/blocks/pomodoro/sounds/press.mp3":M.cfg.wwwroot+"/blocks/pomodoro/sounds/alert.mp3";var audio=new Audio(soundUrl);audio.play()}catch(e){window.navigator&&window.navigator.vibrate&&window.navigator.vibrate(200)}}function $(id){return document.getElementById(id)}function now(){return Date.now()}function readInt(v,d){const n=parseInt(null!=v?v:"",10);return Number.isFinite(n)?n:d}function formatTime(ms){const s=Math.max(0,Math.floor(ms/1e3)),m=Math.floor(s/60).toString().padStart(2,"0"),r=(s%60).toString().padStart(2,"0");return"".concat(m,":").concat(r)}function getTimerElement(){return $("pomodoro-timer-display")}function renderTomatoes(el,sessionscount,interval){if(!el)return;const n=Math.max(0,Number(sessionscount)||0),m=Math.max(1,Number(interval)||0),filled=n%m==0&&0!==n?m:n%m;el.innerHTML=Array.from({length:m},((_,i)=>i<filled?'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="25" height="25" \n                style="vertical-align:middle; margin-right:6px;">\n                <polygon style="fill:#AB2300;" points="512,155.826 478.609,155.826 ..."/>\n               <polygon style="fill:#AB2300;" points="512,155.826 478.609,155.826 478.609,100.174 445.217,100.174 445.217,66.783 \n                    411.826,66.783 411.826,33.391 300.522,33.391 300.522,66.783 267.13,66.783 267.13,0 233.739,0 233.739,66.783 211.478,66.783 \n                    211.478,33.391 100.174,33.391 100.174,66.783 66.783,66.783 66.783,100.174 33.391,100.174 33.391,155.826 0,155.826 0,345.043 \n                    33.391,345.043 33.391,411.826 66.783,411.826 66.783,445.217 100.174,445.217 100.174,478.609 166.957,478.609 166.957,512 \n                    345.043,512 345.043,478.609 411.826,478.609 411.826,445.217 445.217,445.217 445.217,411.826 478.609,411.826 478.609,345.043 \n                    512,345.043 "/>\n                <polygon style="fill:#4E901E;" points="445.217,100.174 445.217,66.783 411.826,66.783 411.826,33.391 300.522,33.391 \n                    300.522,66.783 289.391,66.783 267.13,66.783 267.13,0 233.739,0 233.739,66.783 222.609,66.783 211.478,66.783 211.478,33.391 \n                    100.174,33.391 100.174,66.783 66.783,66.783 66.783,100.174 33.391,100.174 33.391,155.826 66.783,155.826 133.565,155.826 \n                    133.565,222.609 222.609,222.609 222.609,189.217 289.391,189.217 289.391,222.609 378.435,222.609 378.435,155.826 \n                    445.217,155.826 478.609,155.826 478.609,100.174 "/>\n                <polygon points="233.739,100.174 233.739,122.435 267.13,122.435 267.13,100.174 300.522,100.174 300.522,66.783 267.13,66.783 \n                    267.13,0 233.739,0 233.739,66.783 211.478,66.783 211.478,100.174 "/>\n                <rect x="222.609" y="155.826" width="66.783" height="33.391"/>\n                <polygon points="378.435,122.435 345.043,122.435 345.043,155.826 345.043,189.217 289.391,189.217 289.391,222.609 \n                    345.043,222.609 378.435,222.609 378.435,189.217 378.435,155.826 445.217,155.826 478.609,155.826 478.609,122.435 \n                    478.609,100.174 445.217,100.174 445.217,122.435 "/>\n                <rect x="411.826" y="66.783" width="33.391" height="33.391"/>\n                <rect x="300.522" y="33.391" width="111.304" height="33.391"/>\n                <rect x="100.174" y="33.391" width="111.304" height="33.391"/>\n                <rect x="66.783" y="66.783" width="33.391" height="33.391"/>\n                <polygon points="133.565,155.826 133.565,189.217 133.565,222.609 166.957,222.609 222.609,222.609 222.609,189.217 \n                    166.957,189.217 166.957,155.826 166.957,122.435 133.565,122.435 66.783,122.435 66.783,100.174 33.391,100.174 33.391,122.435 \n                    33.391,155.826 66.783,155.826 "/>\n                <rect x="33.391" y="345.043" width="33.391" height="66.783"/>\n                <rect x="66.783" y="411.826" width="33.391" height="33.391"/>\n                <rect x="100.174" y="445.217" width="66.783" height="33.391"/>\n                <rect x="166.957" y="478.609" width="178.087" height="33.391"/>\n                <rect x="345.043" y="445.217" width="66.783" height="33.391"/>\n                <rect x="411.826" y="411.826" width="33.391" height="33.391"/>\n                <rect x="445.217" y="345.043" width="33.391" height="66.783"/>\n                <rect x="478.609" y="155.826" width="33.391" height="189.217"/>\n                <rect y="155.826" width="33.391" height="189.217"/>\n                <g>\n                    <rect x="66.783" y="189.217" style="fill:#FFFFFF;" width="33.391" height="55.652"/>\n                    <rect x="66.783" y="278.261" style="fill:#FFFFFF;" width="33.391" height="33.391"/>\n                </g>\n            </svg>':'<span class="tomato" aria-hidden="true"></span>')).join("")}function openDialog(d){d&&"function"==typeof d.showModal&&d.showModal()}function closeDialog(d){d&&d.open&&d.close()}function startTimer(endTs,el,onDone){let playButton=document.getElementById("start"),pauseButton=document.getElementById("pause");if(state="playing",!el||!Number.isFinite(endTs))return;if(endTs<=now())return localStorage.removeItem(K.END),void localStorage.setItem(K.RUNNING,"0");clearTick();const tick=()=>{const left=endTs-now();if(left<=0)return clearTick(),el.textContent="00:00",localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"),sendMessage({type:"stop"}),void(onDone&&onDone());el.textContent=formatTime(left)};tick(),intervalId=setInterval(tick,1e3),"playing"===state&&(playButton.classList.contains("hidden")||playButton.classList.add("hidden"),pauseButton.classList.contains("hidden")&&pauseButton.classList.remove("hidden"))}function stopAndReset(el){let play=arguments.length>1&&void 0!==arguments[1]&&arguments[1];state="stopped";let playButton=document.getElementById("start"),pauseButton=document.getElementById("pause");"stopped"===state&&(pauseButton.classList.contains("hidden")||pauseButton.classList.add("hidden"),playButton.classList.contains("hidden")&&playButton.classList.remove("hidden")),clearTick(),localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"),sendMessage({type:"stop"}),el&&(el.textContent=formatTime(cfg.focusMs)),play&&alarm()}function startPausePomodoro(onAfter){if(!cfg)return;const display=getTimerElement();if(!display)return;const remainRaw=localStorage.getItem(K.REMAINING),running="1"===localStorage.getItem(K.RUNNING),endRaw=localStorage.getItem(K.END);if(null===remainRaw)if(running){if(null!==endRaw){const left=Number(endRaw)-now();left>0&&(localStorage.setItem(K.REMAINING,String(left)),sendMessage({type:"pause",remaining:left}),display&&(display.textContent=formatTime(left)))}clearTick(),localStorage.setItem(K.RUNNING,"0")}else!function(onAfter){setPhase("wellness");const modal=$("wellness-modal"),countdown=$("wellness-countdown");if(!cfg)return;if(!modal||!countdown)return void onAfter();const end=now()+1e3*cfg.wellnessSec;openDialog(modal),startTimer(end,countdown,(()=>{closeDialog(modal),onAfter()}));const skip=$("skip-wellness");skip&&(skip.type="button",skip.onclick=e=>{alarm("click"),e.preventDefault(),e.stopPropagation(),closeDialog(modal),onAfter()})}(onAfter);else{const remain=Number(remainRaw);Number.isFinite(remain)&&remain>0&&(localStorage.removeItem(K.REMAINING),startFocus(display,remain))}}function startFocus(el,ms){if(!cfg)return;const focusDur=Number.isFinite(ms)&&ms>0?ms:15e5;setPhase("focus");const starttsSec=Math.floor(now()/1e3),end=now()+focusDur;localStorage.setItem(K.END,String(end)),localStorage.setItem(K.RUNNING,"1"),sendMessage({type:"start",end:end}),startTimer(end,el,(()=>{ajax("block_pomodoro_increment_session",{courseid:cfg.courseid,startts:starttsSec}).then((res=>{if(alarm(),!cfg)return;if(plantImg=document.getElementById("plant-img"),!plantImg)return;clearInterval(growInterval),currentFrame=1,plantImg.src=M.util.image_url("plant_1","block_pomodoro"),growInterval=setInterval((()=>{currentFrame<3?(currentFrame++,plantImg.src=M.util.image_url("plant_".concat(currentFrame),"block_pomodoro")):clearInterval(growInterval),growInterval=setInterval((()=>{currentFrame<3?(currentFrame++,plantImg.src=M.util.image_url("plant_".concat(currentFrame),"block_pomodoro")):clearInterval(growInterval)}),1e3),3===currentFrame&&clearInterval(growInterval)}),1e3);const count=res&&"number"==typeof res.sessionscount?res.sessionscount:1;renderTomatoes($("pomodoro-tomatoes"),count,cfg.longbreakInterval);const isLong=(c=count,(i=cfg.longbreakInterval)>0&&c>0&&c%i==0);var c,i;!function(el,ms,kind){setPhase("break",kind);const dlg=$("break-modal"),cd=$("break-countdown");cd&&(cd.textContent=formatTime(ms)),openDialog(dlg),startTimer(now()+ms,cd||el,(()=>{alarm(),closeDialog(dlg),stopAndReset(el,!1)}));const ok=$("dismiss-break");ok&&(ok.type="button",ok.onclick=e=>{alarm("click"),e.preventDefault(),e.stopPropagation(),closeDialog(dlg)})}(el,isLong?cfg.longbreakMs:cfg.shortbreakMs,isLong?"long":"short"),state="stopped";let playButton=document.getElementById("start"),pauseButton=document.getElementById("pause");return"stopped"===state&&(pauseButton.classList.contains("hidden")||pauseButton.classList.add("hidden"),playButton.classList.contains("hidden")&&playButton.classList.remove("hidden")),null})).catch(Notification.exception)}))}function setPhase(p,k){localStorage.setItem(K.PHASE,p),k?localStorage.setItem(K.BREAKKIND,k):localStorage.removeItem(K.BREAKKIND)}function sendMessage(msg){channel?channel.postMessage(msg):(localStorage.setItem(K.MSG,JSON.stringify(Object.assign({},msg,{t:now()}))),setTimeout((function(){localStorage.removeItem(K.MSG)}),50))}function handleMessage(msg,el){if(msg)return"start"===msg.type&&msg.end?(startTimer(Number(msg.end),el),localStorage.setItem(K.END,String(msg.end)),void localStorage.setItem(K.RUNNING,"1")):"pause"===msg.type&&void 0!==msg.remaining?(clearTick(),localStorage.setItem(K.REMAINING,String(msg.remaining)),localStorage.setItem(K.RUNNING,"0"),void(el&&(el.textContent=formatTime(msg.remaining)))):void("stop"===msg.type&&localStorage.getItem(K.END)&&stopAndReset(el,!1))}function ajax(name,args){return Ajax.call([{methodname:name,args:args}])[0].catch(Notification.exception)}return{init(){plantImg=document.getElementById("plant-img");const display=getTimerElement();if(!display)return;cfg=function(timerDisplay){const courseid=readInt(timerDisplay.getAttribute("data-courseid"),0),wellnessSec=readInt(timerDisplay.getAttribute("data-wellness-sec"),30);let focusMs;const focusSec=readInt(timerDisplay.getAttribute("data-focus-sec"),NaN);if(Number.isFinite(focusSec))focusMs=1e3*focusSec;else{let focusMin=readInt(timerDisplay.getAttribute("data-focus-min"),NaN);Number.isFinite(focusMin)||(focusMin=readInt((timerDisplay.getAttribute("data-duration")||"25:00").split(":")[0]||"25",25)),focusMs=60*focusMin*1e3}let shortbreakMs,longbreakMs;const sbSec=readInt(timerDisplay.getAttribute("data-shortbreak-sec"),NaN),lbSec=readInt(timerDisplay.getAttribute("data-longbreak-sec"),NaN);return Number.isFinite(sbSec)&&(shortbreakMs=1e3*sbSec),Number.isFinite(lbSec)&&(longbreakMs=1e3*lbSec),Number.isFinite(shortbreakMs)||(shortbreakMs=60*readInt(timerDisplay.getAttribute("data-shortbreak-min"),5)*1e3),Number.isFinite(longbreakMs)||(longbreakMs=60*readInt(timerDisplay.getAttribute("data-longbreak-min"),15)*1e3),{courseid:courseid,wellnessSec:wellnessSec,focusMs:focusMs,shortbreakMs:shortbreakMs,longbreakMs:longbreakMs,longbreakInterval:readInt(timerDisplay.getAttribute("data-longbreak-interval"),3)}}(display),K=function(courseid){const cid=Number.isFinite(courseid)&&courseid>0?courseid:"global",p="pomodoro:".concat(cid);return{END:"".concat(p,":endTimestamp"),RUNNING:"".concat(p,":running"),PHASE:"".concat(p,":phase"),BREAKKIND:"".concat(p,":breakKind"),MSG:"".concat(p,":msg"),CHANNEL:"".concat(p,":channel")}}(cfg.courseid);const intervalEl=$("pomodoro-interval");intervalEl&&(intervalEl.textContent=String(cfg.longbreakInterval)),"undefined"!=typeof BroadcastChannel&&(channel=new BroadcastChannel(K.CHANNEL),channel.onmessage=e=>handleMessage(e.data,display)),ajax("block_pomodoro_get_status",{courseid:cfg.courseid}).then((res=>{const count=res&&"number"==typeof res.sessionscount?res.sessionscount:0;return renderTomatoes($("pomodoro-tomatoes"),count,cfg.longbreakInterval),null})).catch(Notification.exception);const existingRaw=localStorage.getItem(K.END);if(null!==existingRaw){const existing=Number(existingRaw),phase=localStorage.getItem(K.PHASE)||"";let target;target="wellness"===phase?$("wellness-countdown"):"break"===phase?$("break-countdown"):display,Number.isFinite(existing)&&existing>now()+250?("break"===phase&&openDialog($("break-modal")),"wellness"===phase&&openDialog($("wellness-modal")),startTimer(existing,target||display)):(localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"))}window.addEventListener("storage",(e=>{if(e.key!==K.END){if(e.key===K.MSG&&e.newValue)try{handleMessage(JSON.parse(e.newValue),display)}catch(err){window&&window.console&&"function"==typeof window.console.debug&&window.console.debug("Pomodoro: storage MSG parse ignored",err)}}else if(null!==e.newValue){const val=Number(e.newValue);Number.isFinite(val)&&val>now()+250?startTimer(val,display):(localStorage.removeItem(K.END),localStorage.setItem(K.RUNNING,"0"))}else localStorage.setItem(K.RUNNING,"0")}));const startBtn=$("start");startBtn&&(startBtn.type="button",startBtn.onclick=e=>{alarm("click"),e.preventDefault(),e.stopPropagation(),startPausePomodoro((()=>startFocus(display,cfg.focusMs)))});const stopBtn=$("pause");stopBtn&&(stopBtn.type="button",stopBtn.onclick=e=>{alarm("click"),e.preventDefault(),e.stopPropagation(),stopAndReset(display,!1)}),window.addEventListener("beforeunload",(()=>{channel&&channel.close()}))}}}));
>>>>>>> d4c8fbb (add animatio n)

//# sourceMappingURL=pomodoro_timer.min.js.map