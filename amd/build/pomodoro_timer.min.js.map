<<<<<<< HEAD
{"version":3,"file":"pomodoro_timer.min.js","sources":["../src/pomodoro_timer.js"],"sourcesContent":["/**\n * Pomodoro Timer (AMD) â€” scoped by course, increments only when focus ends.\n * WS: block_pomodoro_increment_session(courseid:int, startts:int [UNIX seconds])\n *     block_pomodoro_get_status(courseid:int)\n */\ndefine(['core/ajax', 'core/notification'], function(Ajax, Notification) {\n    'use strict';\n\n    // ---------------------------------------------------------------------\n    // Module-level shared mutable state (per page load)\n    // ---------------------------------------------------------------------\n    /**\n     * @typedef {Object} Config\n     * @property {number} courseid\n     * @property {number} wellnessSec\n     * @property {number} focusMs\n     * @property {number} shortbreakMs\n     * @property {number} longbreakMs\n     * @property {number} longbreakInterval\n     */\n    /** @type {null|Config} */\n    let cfg = null; // Set in init().\n    /**\n     * @typedef {Object} ScopedKeys\n     * @property {string} END End timestamp key.\n     * @property {string} REMAINING\n     * @property {string} RUNNING Running state key.\n     * @property {string} PHASE\n     * @property {string} BREAKKIND\n     * @property {string} MSG\n     * @property {string} CHANNEL\n     */\n    /** @type {null|ScopedKeys} */\n    let K = null; // Key names (scoped localStorage) set in init().\n    /** @type {null|BroadcastChannel} */\n    let channel = null; // Broadcast channel instance.\n    /** @type {null|number} */\n    let intervalId = null; // Active countdown interval id.\n\n    let state = 'stopped';\n    // ---------------------------------------------------------------------\n    // Utility helpers\n    /**\n     * Clears the active countdown interval, if any.\n     */\n    function clearTick() {\n        if (intervalId !== null) {\n            clearInterval(intervalId);\n            intervalId = null;\n        }\n    }\n\n    /**\n     * Plays an alarm sound (simple beep using Audio API).\n     * @param {string} [kind] Type of alarm sound to play ('click' or other).\n     */\n    function alarm(kind = '') {\n        try {\n            var soundUrl;\n            if (kind === 'click') {\n                soundUrl = M.cfg.wwwroot + '/blocks/pomodoro/sounds/press.mp3';\n            } else {\n                soundUrl = M.cfg.wwwroot + '/blocks/pomodoro/sounds/alert.mp3';\n            }\n            // Create an Audio object\n            var audio = new Audio(soundUrl);// Replace with actual path if needed\n            audio.play();\n        } catch (e) {\n            // Fallback: browser beep\n            if (window.navigator && window.navigator.vibrate) {\n                window.navigator.vibrate(200);\n            }\n        }\n    }\n\n    // ---------------------------------------------------------------------\n    /**\n     * Shorthand getElementById.\n     * @param {string} id\n     * @returns {HTMLElement|null}\n     */\n    function $(id) {\n        return document.getElementById(id);\n    }\n\n    /**\n     * Now in ms.\n     * @returns {number}\n     */\n    function now() {\n        return Date.now();\n    }\n\n    /**\n     * Parse an integer with default.\n     * @param {string|number|undefined|null} v\n     * @param {number} d Default value\n     * @returns {number}\n     */\n    function readInt(v, d) {\n        const n = parseInt(v ?? '', 10);\n        return Number.isFinite(n) ? n : d;\n    }\n\n    /**\n     * Format milliseconds as mm:ss.\n     * @param {number} ms\n     * @returns {string}\n     */\n    function formatTime(ms) {\n        const s = Math.max(0, Math.floor(ms / 1000));\n        const m = Math.floor(s / 60).toString().padStart(2, '0');\n        const r = (s % 60).toString().padStart(2, '0');\n        return `${m}:${r}`;\n    }\n\n    // =====================\n    // UI Functions\n    // =====================\n    /**\n     * Returns the display element for the Pomodoro timer.\n     * @returns {HTMLElement|null}\n     */\n    function getTimerElement() {\n        return $('pomodoro-timer-display');\n    }\n\n    /**\n     * Renders tomato icons for Pomodoro sessions.\n     * @param {HTMLElement} el The container element.\n     * @param {number} sessionscount Number of completed sessions.\n     * @param {number} interval Number of sessions per long break.\n     */\n    function renderTomatoes(el, sessionscount, interval) {\n        if (!el) {\n            return;\n        }\n        const n = Math.max(0, Number(sessionscount) || 0);\n        const m = Math.max(1, Number(interval) || 0);\n        const filled = ((n % m) === 0 && n !== 0) ? m : (n % m);\n        el.innerHTML = Array.from({length: m}, (_, i) =>\n            `<span class=\"tomato ${i < filled ? 'filled' : ''}\" aria-hidden=\"true\"></span>`\n        ).join('');\n    }\n\n    /**\n     * Opens the dialog element.\n     * @param {HTMLDialogElement} d The dialog element to open.\n     */\n    function openDialog(d) {\n        if (d && typeof d.showModal === 'function') {\n            d.showModal();\n        }\n    }\n\n    /**\n     * Closes the dialog element.\n     * @param {HTMLDialogElement} d The dialog element to open.\n     */\n    function closeDialog(d) {\n        if (d && d.open) {\n            d.close();\n        }\n    }\n\n    // =====================\n    // Pomodoro Logic\n    // =====================\n    /**\n     * Extracts Pomodoro configuration from the timer display element. Fallback to defaults if attributes are missing or invalid.\n     * @param {HTMLElement} timerDisplay The timer display element.\n     * @returns {Config}\n     */\n    function getConfig(timerDisplay) {\n        const courseid = readInt(timerDisplay.getAttribute('data-courseid'), 0);\n        const wellnessSec = readInt(timerDisplay.getAttribute('data-wellness-sec'), 30);\n        let focusMs;\n        const focusSec = readInt(timerDisplay.getAttribute('data-focus-sec'), NaN);\n        if (Number.isFinite(focusSec)) {\n            focusMs = focusSec * 1000;\n        } else {\n            let focusMin = readInt(timerDisplay.getAttribute('data-focus-min'), NaN);\n            if (!Number.isFinite(focusMin)) {\n                const dur = timerDisplay.getAttribute('data-duration') || '25:00';\n                const parts = dur.split(':');\n                const mm = parts[0] || '25';\n                focusMin = readInt(mm, 25);\n            }\n            focusMs = focusMin * 60 * 1000;\n        }\n        let shortbreakMs;\n        let longbreakMs;\n        const sbSec = readInt(timerDisplay.getAttribute('data-shortbreak-sec'), NaN);\n        const lbSec = readInt(timerDisplay.getAttribute('data-longbreak-sec'), NaN);\n        if (Number.isFinite(sbSec)) {\n            shortbreakMs = sbSec * 1000;\n        }\n        if (Number.isFinite(lbSec)) {\n            longbreakMs = lbSec * 1000;\n        }\n        if (!Number.isFinite(shortbreakMs)) {\n            shortbreakMs = readInt(timerDisplay.getAttribute('data-shortbreak-min'), 5) * 60 * 1000;\n        }\n        if (!Number.isFinite(longbreakMs)) {\n            longbreakMs = readInt(timerDisplay.getAttribute('data-longbreak-min'), 15) * 60 * 1000;\n        }\n        const longbreakInterval = readInt(timerDisplay.getAttribute('data-longbreak-interval'), 3);\n        return {courseid, wellnessSec, focusMs, shortbreakMs, longbreakMs, longbreakInterval};\n    }\n\n    /**\n     * Determines if the next break is a long break.\n     * @param {number} c Number of completed sessions.\n     * @param {number} i Interval for long breaks.\n     */\n    function nextIsLongBreak(c, i) {\n        return i > 0 && c > 0 && (c % i) === 0;\n    }\n\n    /**\n     * Starts the countdown timer.\n     * @param {number} endTs Timestamp (ms) when the timer ends.\n     * @param {HTMLElement} el Element to display the countdown.\n     * @param {Function} onDone Callback when timer finishes.\n     */\n    function startTimer(endTs, el, onDone) {\n        let playButton = document.getElementById('start');\n        let pauseButton = document.getElementById('pause');\n        state = 'playing';\n        if (!el || !Number.isFinite(endTs)) {\n            return;\n        }\n        if (endTs <= now()) {\n            localStorage.removeItem(K.END);\n            localStorage.setItem(K.RUNNING, '0');\n            return;\n        }\n\n        clearTick();\n        const tick = () => {\n            const left = endTs - now();\n            if (left <= 0) {\n                clearTick();\n                el.textContent = '00:00';\n                localStorage.removeItem(K.END);\n                localStorage.setItem(K.RUNNING, '0');\n                sendMessage({type: 'stop'});\n                if (onDone) {\n                    onDone();\n                }\n                return;\n            }\n            el.textContent = formatTime(left);\n        };\n        tick();\n        intervalId = setInterval(tick, 1000);\n\n        if (state === 'playing') {\n            if(!playButton.classList.contains('hidden')){\n                playButton.classList.add('hidden');\n            }\n\n            if(pauseButton.classList.contains('hidden')){\n                pauseButton.classList.remove('hidden');\n            }\n        }\n    }\n\n    /**\n     * Stop the timer and reset the display.\n     * @param {HTMLElement} el The element to update with reset time.\n     * @param {boolean} play Whether to play the alarm sound.\n     */\n    function stopAndReset(el, play = false) {\n        state = 'stopped';\n\n        let playButton = document.getElementById('start');\n        let pauseButton = document.getElementById('pause');\n\n        if (state === 'stopped') {\n            if(!pauseButton.classList.contains('hidden')){\n                pauseButton.classList.add('hidden');\n            }\n\n            if(playButton.classList.contains('hidden')){\n                playButton.classList.remove('hidden');\n            }\n        }\n    clearTick();\n        localStorage.removeItem(K.END);\n        localStorage.setItem(K.RUNNING, '0');\n        sendMessage({type: 'stop'});\n        if (el) {\n            el.textContent = formatTime(cfg.focusMs);\n        }\n        if (play) {\n            alarm();\n        }\n    }\n\n    /**\n     * Starts or pauses the Pomodoro timer.\n     * @param {Function} onAfter Callback to execute after starting wellness or focus.\n     */\n    function startPausePomodoro(onAfter) {\n        if (!cfg) {\n            return;\n        }\n        const display = getTimerElement();\n        if (!display) {\n            return;\n        }\n\n        const remainRaw = localStorage.getItem(K.REMAINING);\n        const running = localStorage.getItem(K.RUNNING) === '1';\n        const endRaw = localStorage.getItem(K.END);\n\n        // Resume\n        if (remainRaw !== null) {\n            // Continue timer from REMAINING\n            const remain = Number(remainRaw);\n            if (Number.isFinite(remain) && remain > 0) {\n                localStorage.removeItem(K.REMAINING);\n                startFocus(display, remain);\n            }\n            return;\n        }\n\n        // Start\n        if (!running) {\n            // Not running, start wellness then focus\n            startWellness(onAfter);\n            return;\n        }\n\n        // Pause\n        if (endRaw !== null) {\n            const end = Number(endRaw);\n            const left = end - now();\n            if (left > 0) {\n                localStorage.setItem(K.REMAINING, String(left));\n                sendMessage({type: 'pause', remaining: left});\n                if (display) {\n                    display.textContent = formatTime(left);\n                }\n            }\n        }\n        clearTick();\n        localStorage.setItem(K.RUNNING, '0');\n    }\n\n    /**\n     * Start the wellness countdown and call the callback after completion.\n     * @param {Function} onAfter Callback to execute after wellness period ends.\n     */\n    function startWellness(onAfter) {\n        setPhase('wellness');\n        const modal = $('wellness-modal');\n        const countdown = $('wellness-countdown');\n        if (!cfg) {\n            return;\n        }\n        if (!modal || !countdown) {\n            onAfter();\n            return;\n        }\n        const end = now() + cfg.wellnessSec * 1000;\n        openDialog(modal);\n        startTimer(end, countdown, () => {\n            closeDialog(modal);\n            onAfter();\n        });\n        const skip = $('skip-wellness');\n        if (skip) {\n            skip.type = 'button';\n            skip.onclick = (e) => {\n                alarm('click')\n                e.preventDefault();\n                e.stopPropagation();\n                closeDialog(modal);\n                onAfter();\n            };\n        }\n    }\n\n    /**\n     * Start a break timer and handle break modal UI.\n     * @param {HTMLElement} el The element to update with the break time.\n     * @param {number} ms Duration of the break in milliseconds.\n     * @param {string} kind Type of break ('short' or 'long').\n     */\n    function startBreak(el, ms, kind) {\n        setPhase('break', kind);\n        const dlg = $('break-modal');\n        const cd = $('break-countdown');\n        if (cd) {\n            cd.textContent = formatTime(ms);\n        }\n        openDialog(dlg);\n        const end = now() + ms;\n        startTimer(end, cd || el, () => {\n            alarm('focus');\n            closeDialog(dlg);\n            stopAndReset(el, false);\n        });\n        const ok = $('dismiss-break');\n        if (ok) {\n            ok.type = 'button';\n            ok.onclick = (e) => {\n                alarm('click');\n                e.preventDefault();\n                e.stopPropagation();\n                closeDialog(dlg);\n            };\n        }\n    }\n\n    /**\n     * Starts the focus timer.\n     * @param {HTMLElement} el The element to display the countdown.\n     * @param {number} ms Duration of the focus period in milliseconds.\n     */\n    function startFocus(el, ms) {\n        if (!cfg) {\n            return;\n        }\n        const focusDur = Number.isFinite(ms) && ms > 0 ? ms : 25 * 60 * 1000;\n        setPhase('focus');\n        const starttsSec = Math.floor(now() / 1000);\n        const end = now() + focusDur;\n        localStorage.setItem(K.END, String(end));\n        localStorage.setItem(K.RUNNING, '1');\n        sendMessage({type: 'start', end});\n        startTimer(end, el, () => {\n            ajax('block_pomodoro_increment_session', {courseid: cfg.courseid, startts: starttsSec})\n                .then((res) => {\n                    alarm();\n                    const count = res && typeof res.sessionscount === 'number' ? res.sessionscount : 1;\n                    renderTomatoes($('pomodoro-tomatoes'), count, cfg.longbreakInterval);\n                    const isLong = nextIsLongBreak(count, cfg.longbreakInterval);\n                    startBreak(el, isLong ? cfg.longbreakMs : cfg.shortbreakMs, isLong ? 'long' : 'short');\n                    state = 'stopped';\n                    let playButton = document.getElementById('start');\n                    let pauseButton = document.getElementById('pause');\n                    if (state === 'stopped') {\n                        if(!pauseButton.classList.contains('hidden')){\n                            pauseButton.classList.add('hidden');\n                        }\n\n                        if(playButton.classList.contains('hidden')){\n                            playButton.classList.remove('hidden');\n                        }\n                    }\n                    return null;\n                })\n                .catch(Notification.exception);\n        });\n    }\n\n    // =====================\n    // State Storage & Inter-tab Communication\n    // =====================\n    /**\n     * Returns scoped localStorage key names for a given course.\n     * @param {number} courseid The course ID to scope keys.\n     */\n    function scoped(courseid) {\n        /** @returns {ScopedKeys} */\n        const cid = Number.isFinite(courseid) && courseid > 0 ? courseid : 'global';\n        const p = `pomodoro:${cid}`;\n        return {\n            END: `${p}:endTimestamp`,\n            RUNNING: `${p}:running`,\n            PHASE: `${p}:phase`,\n            BREAKKIND: `${p}:breakKind`,\n            MSG: `${p}:msg`,\n            CHANNEL: `${p}:channel`\n        };\n    }\n\n    /**\n     * Sets the current phase and optional break kind in localStorage.\n     * @param {string} p Phase name.\n     * @param {string} [k] Optional break kind.\n     */\n    function setPhase(p, k) {\n        localStorage.setItem(K.PHASE, p);\n        if (k) {\n            localStorage.setItem(K.BREAKKIND, k);\n        } else {\n            localStorage.removeItem(K.BREAKKIND);\n        }\n    }\n\n    /**\n     * Gets the current phase from localStorage.\n     * @returns {string} The current phase name.\n     */\n    function getPhase() {\n        return localStorage.getItem(K.PHASE) || '';\n    }\n\n    /**\n     * Send a message to other tabs or via BroadcastChannel.\n     * @param {Object} msg The message object to send.\n     */\n    function sendMessage(msg) {\n        if (channel) {\n            channel.postMessage(msg);\n        } else {\n            localStorage.setItem(K.MSG, JSON.stringify(Object.assign({}, msg, {t: now()})));\n            setTimeout(function() {\n                localStorage.removeItem(K.MSG);\n            }, 50);\n        }\n    }\n\n    /**\n     * Handle incoming messages for timer synchronization.\n     * @param {Object} msg The message object.\n     * @param {HTMLElement} el The display element to update.\n     */\n    function handleMessage(msg, el) {\n        if (!msg) {\n            return;\n        }\n        if (msg.type === 'start' && msg.end) {\n            startTimer(Number(msg.end), el);\n            localStorage.setItem(K.END, String(msg.end));\n            localStorage.setItem(K.RUNNING, '1');\n            return;\n        }\n        if (msg.type === 'pause' && typeof msg.remaining !== 'undefined') {\n            clearTick();\n            localStorage.setItem(K.REMAINING, String(msg.remaining));\n            localStorage.setItem(K.RUNNING, '0');\n            if (el) {\n                el.textContent = formatTime(msg.remaining);\n            }\n            return;\n        }\n        if ((msg.type === 'stop') && localStorage.getItem(K.END)) {\n            stopAndReset(el, false);\n        }\n    }\n\n    /**\n     * Make an AJAX call using Moodle's core Ajax API.\n     * @param {string} name The web service method name.\n     * @param {Object} args Arguments for the web service call.\n     * @returns {Promise<any>} Promise resolving to the response.\n     */\n    function ajax(name, args) {\n        return Ajax.call([{methodname: name, args}])[0].catch(Notification.exception);\n    }\n\n    return {\n        init() {\n            const display = getTimerElement();\n            if (!display) {\n                return;\n            }\n            cfg = getConfig(display);\n            K = scoped(cfg.courseid);\n\n            // UI: show interval number\n            const intervalEl = $('pomodoro-interval');\n            if (intervalEl) {\n                intervalEl.textContent = String(cfg.longbreakInterval);\n            }\n\n            // Broadcast channel\n            if (typeof BroadcastChannel !== 'undefined') {\n                channel = new BroadcastChannel(K.CHANNEL);\n                channel.onmessage = (e) => handleMessage(e.data, display);\n            }\n\n            // Initial tomatoes from server\n            ajax('block_pomodoro_get_status', {courseid: cfg.courseid})\n                .then((res) => {\n                    const count = res && typeof res.sessionscount === 'number' ? res.sessionscount : 0;\n                    renderTomatoes($('pomodoro-tomatoes'), count, cfg.longbreakInterval);\n                    return null;\n                })\n                .catch(Notification.exception);\n\n            // Resume (only if future)\n            const existingRaw = localStorage.getItem(K.END);\n            if (existingRaw !== null) {\n                const existing = Number(existingRaw);\n                const phase = getPhase();\n                let target;\n                if (phase === 'wellness') {\n                    target = $('wellness-countdown');\n                } else if (phase === 'break') {\n                    target = $('break-countdown');\n                } else {\n                    target = display;\n                }\n                if (Number.isFinite(existing) && existing > now() + 250) {\n                    if (phase === 'break') {\n                        openDialog($('break-modal'));\n                    }\n                    if (phase === 'wellness') {\n                        openDialog($('wellness-modal'));\n                    }\n                    startTimer(existing, target || display);\n                } else {\n                    localStorage.removeItem(K.END);\n                    localStorage.setItem(K.RUNNING, '0');\n                }\n            }\n\n            // Storage sync for this course key\n            window.addEventListener('storage', (e) => {\n                if (e.key === K.END) {\n                    if (e.newValue !== null) {\n                        const val = Number(e.newValue);\n                        if (Number.isFinite(val) && val > now() + 250) {\n                            startTimer(val, display);\n                        } else {\n                            localStorage.removeItem(K.END);\n                            localStorage.setItem(K.RUNNING, '0');\n                        }\n                    } else {\n                        localStorage.setItem(K.RUNNING, '0');\n                    }\n                    return;\n                }\n                if (e.key === K.MSG && e.newValue) {\n                    try {\n                        handleMessage(JSON.parse(e.newValue), display);\n                    } catch (err) {\n                        // Ignore malformed or transient values during storage sync\n                        if (window && window.console && typeof window.console.debug === 'function') {\n                            window.console.debug('Pomodoro: storage MSG parse ignored', err);\n                        }\n                    }\n                }\n            });\n\n            const startBtn = $('start');\n            if (startBtn) {\n                startBtn.type = 'button';\n                startBtn.onclick = (e) => {\n                    alarm('click');\n                    e.preventDefault();\n                    e.stopPropagation();\n                    startPausePomodoro(() => startFocus(display, cfg.focusMs));\n                };\n            }\n            const stopBtn = $('pause');\n            if (stopBtn) {\n                stopBtn.type = 'button';\n                stopBtn.onclick = (e) => {\n                    alarm('click');\n                    e.preventDefault();\n                    e.stopPropagation();\n                    stopAndReset(display, false);\n                };\n            }\n\n            window.addEventListener('beforeunload', () => {\n                if (channel) {\n                    channel.close();\n                }\n            });\n        }\n    };\n});\n"],"names":["define","Ajax","Notification","cfg","K","channel","intervalId","state","clearTick","clearInterval","alarm","kind","arguments","length","undefined","soundUrl","M","wwwroot","Audio","play","e","window","navigator","vibrate","$","id","document","getElementById","now","Date","readInt","v","d","n","parseInt","Number","isFinite","formatTime","ms","s","Math","max","floor","toString","padStart","getTimerElement","renderTomatoes","el","sessionscount","interval","m","filled","innerHTML","Array","from","_","i","join","openDialog","showModal","closeDialog","open","close","startTimer","endTs","onDone","playButton","pauseButton","localStorage","removeItem","END","setItem","RUNNING","tick","left","textContent","sendMessage","type","setInterval","classList","contains","add","remove","stopAndReset","focusMs","startPausePomodoro","onAfter","display","remainRaw","getItem","REMAINING","running","endRaw","remain","startFocus","String","remaining","setPhase","modal","countdown","end","wellnessSec","skip","onclick","preventDefault","stopPropagation","startWellness","focusDur","starttsSec","ajax","courseid","startts","then","res","count","longbreakInterval","isLong","c","dlg","cd","ok","startBreak","longbreakMs","shortbreakMs","catch","exception","p","k","PHASE","BREAKKIND","msg","postMessage","MSG","JSON","stringify","Object","assign","t","setTimeout","handleMessage","name","args","call","methodname","init","timerDisplay","getAttribute","focusSec","NaN","focusMin","split","sbSec","lbSec","getConfig","CHANNEL","scoped","intervalEl","BroadcastChannel","onmessage","data","existingRaw","existing","phase","target","addEventListener","key","newValue","parse","err","console","debug","val","startBtn","stopBtn"],"mappings":"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"}
=======
{"version":3,"file":"pomodoro_timer.min.js","sources":["../src/pomodoro_timer.js"],"sourcesContent":["/**\n * Pomodoro Timer (AMD) â€” scoped by course, increments only when focus ends.\n * WS: block_pomodoro_increment_session(courseid:int, startts:int [UNIX seconds])\n *     block_pomodoro_get_status(courseid:int)\n */\ndefine(['core/ajax', 'core/notification'], function(Ajax, Notification) {\n    'use strict';\n\n    // =====================\n    // Module-level shared mutable state (per page load)\n    // =====================\n    /**\n     * @typedef {Object} Config\n     * @property {number} courseid\n     * @property {number} wellnessSec\n     * @property {number} focusMs\n     * @property {number} shortbreakMs\n     * @property {number} longbreakMs\n     * @property {number} longbreakInterval\n     */\n    /** @type {null|Config} */\n    let cfg = null; // Set in init().\n    /**\n     * @typedef {Object} ScopedKeys\n     * @property {string} END End timestamp key.\n     * @property {string} REMAINING\n     * @property {string} RUNNING Running state key.\n     * @property {string} PHASE\n     * @property {string} BREAKKIND\n     * @property {string} MSG\n     * @property {string} CHANNEL\n     */\n    /** @type {null|ScopedKeys} */\n    let K = null; // Key names (scoped localStorage) set in init().\n    /** @type {null|BroadcastChannel} */\n    let channel = null; // Broadcast channel instance.\n    /** @type {null|number} */\n    let intervalId = null; // Active countdown interval id.\n\n    // =====================\n    // Utility helpers\n    // =====================\n    /**\n     * Clears the active countdown interval, if any.\n     */\n    function clearTick() {\n        if (intervalId !== null) {\n            clearInterval(intervalId);\n            intervalId = null;\n        }\n    }\n\n    /**\n     * Plays an alarm sound (simple beep using Audio API).\n     * @param {string} [kind] Type of alarm sound to play ('click' or other).\n     */\n    function alarm(kind = '') {\n        try {\n            const soundUrl = kind === 'click'\n                ? `${M.cfg.wwwroot}/blocks/pomodoro/sounds/press.mp3`\n                : `${M.cfg.wwwroot}/blocks/pomodoro/sounds/alert.mp3`;\n            const audio = new Audio(soundUrl);\n            audio.play().catch(() => {\n                if (navigator.vibrate) {\n                    navigator.vibrate(200);\n                }\n            });\n        } catch {\n            if (navigator.vibrate) {\n                navigator.vibrate(200);\n            }\n        }\n    }\n\n    /**\n     * Shorthand getElementById.\n     * @param {string} id\n     * @returns {HTMLElement|null}\n     */\n    function $(id) {\n        return document.getElementById(id);\n    }\n\n    /**\n     * Now in ms.\n     * @returns {number}\n     */\n    function now() {\n        return Date.now();\n    }\n\n    /**\n     * Parse an integer with default.\n     * @param {string|number|undefined|null} v\n     * @param {number} d Default value\n     * @returns {number}\n     */\n    function readInt(v, d) {\n        const n = parseInt(v ?? '', 10);\n        return Number.isFinite(n) ? n : d;\n    }\n\n    /**\n     * Format milliseconds as mm:ss.\n     * @param {number} ms\n     * @returns {string}\n     */\n    function formatTime(ms) {\n        const s = Math.max(0, Math.floor(ms / 1000));\n        const m = Math.floor(s / 60).toString().padStart(2, '0');\n        const r = (s % 60).toString().padStart(2, '0');\n        return `${m}:${r}`;\n    }\n\n    // =====================\n    // UI Functions\n    // =====================\n    /**\n     * Returns the display element for the Pomodoro timer.\n     * @returns {HTMLElement|null}\n     */\n    function getTimerElement() {\n        return $('pomodoro-timer-display');\n    }\n\n    /**\n     * Renders tomato icons for Pomodoro sessions.\n     * @param {HTMLElement} el The container element.\n     * @param {number} sessionscount Number of completed sessions.\n     * @param {number} interval Number of sessions per long break.\n     */\n    function renderTomatoes(el, sessionscount, interval) {\n        if (!el) {\n            return;\n        }\n        const n = Math.max(0, Number(sessionscount) || 0);\n        const m = Math.max(1, Number(interval) || 0);\n        const filled = ((n % m) === 0 && n !== 0) ? m : (n % m);\n        el.innerHTML = Array.from({length: m}, (_, i) =>\n            `<span class=\"tomato ${i < filled ? 'filled' : ''}\" aria-hidden=\"true\"></span>`\n        ).join('');\n    }\n\n    /**\n     * Opens the dialog element.\n     * @param {HTMLDialogElement} d The dialog element to open.\n     */\n    function openDialog(d) {\n        if (d && typeof d.showModal === 'function') {\n            d.showModal();\n        }\n    }\n\n    /**\n     * Closes the dialog element.\n     * @param {HTMLDialogElement} d The dialog element to open.\n     */\n    function closeDialog(d) {\n        if (d && d.open) {\n            d.close();\n        }\n    }\n\n    // =====================\n    // Pomodoro Logic\n    // =====================\n    /**\n     * Extracts Pomodoro configuration from the timer display element. Fallback to defaults if attributes are missing or invalid.\n     * @param {HTMLElement} timerDisplay The timer display element.\n     * @returns {Config}\n     */\n    function getConfig(timerDisplay) {\n        const courseid = readInt(timerDisplay.getAttribute('data-courseid'), 0);\n        const wellnessSec = readInt(timerDisplay.getAttribute('data-wellness-sec'), 30);\n        let focusMs;\n        const focusSec = readInt(timerDisplay.getAttribute('data-focus-sec'), NaN);\n        if (Number.isFinite(focusSec)) {\n            focusMs = focusSec * 1000;\n        } else {\n            let focusMin = readInt(timerDisplay.getAttribute('data-focus-min'), NaN);\n            if (!Number.isFinite(focusMin)) {\n                const dur = timerDisplay.getAttribute('data-duration') || '25:00';\n                const parts = dur.split(':');\n                const mm = parts[0] || '25';\n                focusMin = readInt(mm, 25);\n            }\n            focusMs = focusMin * 60 * 1000;\n        }\n        let shortbreakMs;\n        let longbreakMs;\n        const sbSec = readInt(timerDisplay.getAttribute('data-shortbreak-sec'), NaN);\n        const lbSec = readInt(timerDisplay.getAttribute('data-longbreak-sec'), NaN);\n        if (Number.isFinite(sbSec)) {\n            shortbreakMs = sbSec * 1000;\n        }\n        if (Number.isFinite(lbSec)) {\n            longbreakMs = lbSec * 1000;\n        }\n        if (!Number.isFinite(shortbreakMs)) {\n            shortbreakMs = readInt(timerDisplay.getAttribute('data-shortbreak-min'), 5) * 60 * 1000;\n        }\n        if (!Number.isFinite(longbreakMs)) {\n            longbreakMs = readInt(timerDisplay.getAttribute('data-longbreak-min'), 15) * 60 * 1000;\n        }\n        const longbreakInterval = readInt(timerDisplay.getAttribute('data-longbreak-interval'), 3);\n        return {courseid, wellnessSec, focusMs, shortbreakMs, longbreakMs, longbreakInterval};\n    }\n\n    /**\n     * Determines if the next break is a long break.\n     * @param {number} c Number of completed sessions.\n     * @param {number} i Interval for long breaks.\n     */\n    function nextIsLongBreak(c, i) {\n        return i > 0 && c > 0 && (c % i) === 0;\n    }\n\n    /**\n     * Starts the countdown timer.\n     * @param {number} endTs Timestamp (ms) when the timer ends.\n     * @param {HTMLElement} el Element to display the countdown.\n     * @param {Function} onDone Callback when timer finishes.\n     */\n    function startTimer(endTs, el, onDone) {\n        if (!el || !Number.isFinite(endTs)) {\n            return;\n        }\n        if (endTs <= now()) {\n            localStorage.removeItem(K.END);\n            localStorage.setItem(K.RUNNING, '0');\n            return;\n        }\n        clearTick();\n        const tick = () => {\n            const left = endTs - now();\n            if (left <= 0) {\n                clearTick();\n                el.textContent = '00:00';\n                localStorage.removeItem(K.END);\n                localStorage.setItem(K.RUNNING, '0');\n                sendMessage({type: 'stop'});\n                if (onDone) {\n                    onDone();\n                }\n                return;\n            }\n            el.textContent = formatTime(left);\n        };\n        tick();\n        intervalId = setInterval(tick, 1000);\n    }\n\n    /**\n     * Stop the timer and reset the display.\n     * @param {HTMLElement} el The element to update with reset time.\n     * @param {boolean} triggerAlarm Whether to play the alarm sound.\n     */\n    function stopAndReset(el, triggerAlarm = false) {\n        clearTick();\n        localStorage.removeItem(K.END);\n        localStorage.setItem(K.RUNNING, '0');\n        sendMessage({type: 'stop'});\n        if (el) {\n            el.textContent = formatTime(cfg.focusMs);\n        }\n        if (triggerAlarm) {\n            alarm();\n        }\n    }\n\n    /**\n     * Starts or pauses the Pomodoro timer.\n     * @param {Function} onAfter Callback to execute after starting wellness or focus.\n     */\n    function startPausePomodoro(onAfter) {\n        if (!cfg) {\n            return;\n        }\n        const display = getTimerElement();\n        if (!display) {\n            return;\n        }\n\n        const remainRaw = localStorage.getItem(K.REMAINING);\n        const running = localStorage.getItem(K.RUNNING) === '1';\n        const endRaw = localStorage.getItem(K.END);\n\n        // Resume\n        if (remainRaw !== null) {\n            // Continue timer from REMAINING\n            const remain = Number(remainRaw);\n            if (Number.isFinite(remain) && remain > 0) {\n                localStorage.removeItem(K.REMAINING);\n                startFocus(display, remain);\n            }\n            return;\n        }\n\n        // Start\n        if (!running) {\n            // Not running, start wellness then focus\n            startWellness(onAfter);\n            return;\n        }\n\n        // Pause\n        if (endRaw !== null) {\n            const end = Number(endRaw);\n            const left = end - now();\n            if (left > 0) {\n                localStorage.setItem(K.REMAINING, String(left));\n                sendMessage({type: 'pause', remaining: left});\n                if (display) {\n                    display.textContent = formatTime(left);\n                }\n            }\n        }\n        clearTick();\n        localStorage.setItem(K.RUNNING, '0');\n    }\n\n    /**\n     * Start the wellness countdown and call the callback after completion.\n     * @param {Function} onAfter Callback to execute after wellness period ends.\n     */\n    function startWellness(onAfter) {\n        setPhase('wellness');\n        const modal = $('wellness-modal');\n        const countdown = $('wellness-countdown');\n        if (!cfg) {\n            return;\n        }\n        if (!modal || !countdown) {\n            onAfter();\n            return;\n        }\n        const end = now() + cfg.wellnessSec * 1000;\n        openDialog(modal);\n        startTimer(end, countdown, () => {\n            closeDialog(modal);\n            onAfter();\n        });\n        const skip = $('skip-wellness');\n        if (skip) {\n            skip.type = 'button';\n            skip.onclick = (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                closeDialog(modal);\n                onAfter();\n            };\n        }\n    }\n\n    /**\n     * Start a break timer and handle break modal UI.\n     * @param {HTMLElement} el The element to update with the break time.\n     * @param {number} ms Duration of the break in milliseconds.\n     * @param {string} kind Type of break ('short' or 'long').\n     */\n    function startBreak(el, ms, kind) {\n        setPhase('break', kind);\n        const dlg = $('break-modal');\n        const cd = $('break-countdown');\n        if (cd) {\n            cd.textContent = formatTime(ms);\n        }\n        openDialog(dlg);\n        const end = now() + ms;\n        startTimer(end, cd || el, () => {\n            alarm('focus');\n            closeDialog(dlg);\n            stopAndReset(el, false);\n        });\n        const ok = $('dismiss-break');\n        if (ok) {\n            ok.type = 'button';\n            ok.onclick = (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                closeDialog(dlg);\n            };\n        }\n    }\n\n    /**\n     * Starts the focus timer.\n     * @param {HTMLElement} el The element to display the countdown.\n     * @param {number} ms Duration of the focus period in milliseconds.\n     */\n    function startFocus(el, ms) {\n        if (!cfg) {\n            return;\n        }\n        const focusDur = Number.isFinite(ms) && ms > 0 ? ms : 25 * 60 * 1000;\n        setPhase('focus');\n        const starttsSec = Math.floor(now() / 1000);\n        const end = now() + focusDur;\n        localStorage.setItem(K.END, String(end));\n        localStorage.setItem(K.RUNNING, '1');\n        sendMessage({type: 'start', end});\n        startTimer(end, el, () => {\n            ajax('block_pomodoro_increment_session', {courseid: cfg.courseid, startts: starttsSec})\n                .then((res) => {\n                    alarm();\n                    const count = res && typeof res.sessionscount === 'number' ? res.sessionscount : 1;\n                    renderTomatoes($('pomodoro-tomatoes'), count, cfg.longbreakInterval);\n                    const isLong = nextIsLongBreak(count, cfg.longbreakInterval);\n                    startBreak(el, isLong ? cfg.longbreakMs : cfg.shortbreakMs, isLong ? 'long' : 'short');\n                    return null;\n                })\n                .catch(Notification.exception);\n        });\n    }\n\n    // =====================\n    // State Storage & Inter-tab Communication\n    // =====================\n    /**\n     * Returns scoped localStorage key names for a given course.\n     * @param {number} courseid The course ID to scope keys.\n     */\n    function scoped(courseid) {\n        /** @returns {ScopedKeys} */\n        const cid = Number.isFinite(courseid) && courseid > 0 ? courseid : 'global';\n        const p = `pomodoro:${cid}`;\n        return {\n            END: `${p}:endTimestamp`,\n            RUNNING: `${p}:running`,\n            PHASE: `${p}:phase`,\n            BREAKKIND: `${p}:breakKind`,\n            MSG: `${p}:msg`,\n            CHANNEL: `${p}:channel`\n        };\n    }\n\n    /**\n     * Sets the current phase and optional break kind in localStorage.\n     * @param {string} p Phase name.\n     * @param {string} [k] Optional break kind.\n     */\n    function setPhase(p, k) {\n        localStorage.setItem(K.PHASE, p);\n        if (k) {\n            localStorage.setItem(K.BREAKKIND, k);\n        } else {\n            localStorage.removeItem(K.BREAKKIND);\n        }\n    }\n\n    /**\n     * Gets the current phase from localStorage.\n     * @returns {string} The current phase name.\n     */\n    function getPhase() {\n        return localStorage.getItem(K.PHASE) || '';\n    }\n\n    /**\n     * Send a message to other tabs or via BroadcastChannel.\n     * @param {Object} msg The message object to send.\n     */\n    function sendMessage(msg) {\n        if (channel) {\n            channel.postMessage(msg);\n        } else {\n            localStorage.setItem(K.MSG, JSON.stringify(Object.assign({}, msg, {t: now()})));\n            setTimeout(function() {\n                localStorage.removeItem(K.MSG);\n            }, 50);\n        }\n    }\n\n    /**\n     * Handle incoming messages for timer synchronization.\n     * @param {Object} msg The message object.\n     * @param {HTMLElement} el The display element to update.\n     */\n    function handleMessage(msg, el) {\n        if (!msg) {\n            return;\n        }\n        if (msg.type === 'start' && msg.end) {\n            startTimer(Number(msg.end), el);\n            localStorage.setItem(K.END, String(msg.end));\n            localStorage.setItem(K.RUNNING, '1');\n            return;\n        }\n        if (msg.type === 'pause' && typeof msg.remaining !== 'undefined') {\n            clearTick();\n            localStorage.setItem(K.REMAINING, String(msg.remaining));\n            localStorage.setItem(K.RUNNING, '0');\n            if (el) {\n                el.textContent = formatTime(msg.remaining);\n            }\n            return;\n        }\n        if ((msg.type === 'stop') && localStorage.getItem(K.END)) {\n            stopAndReset(el, false);\n        }\n    }\n\n    /**\n     * Make an AJAX call using Moodle's core Ajax API.\n     * @param {string} name The web service method name.\n     * @param {Object} args Arguments for the web service call.\n     * @returns {Promise<any>} Promise resolving to the response.\n     */\n    function ajax(name, args) {\n        return Ajax.call([{methodname: name, args}])[0].catch(Notification.exception);\n    }\n\n    return {\n        init() {\n            const display = getTimerElement();\n            if (!display) {\n                return;\n            }\n            cfg = getConfig(display);\n            K = scoped(cfg.courseid);\n\n            // UI: show interval number\n            const intervalEl = $('pomodoro-interval');\n            if (intervalEl) {\n                intervalEl.textContent = String(cfg.longbreakInterval);\n            }\n\n            // Broadcast channel\n            if (typeof BroadcastChannel !== 'undefined') {\n                channel = new BroadcastChannel(K.CHANNEL);\n                channel.onmessage = (e) => handleMessage(e.data, display);\n            }\n\n            // Initial tomatoes from server\n            ajax('block_pomodoro_get_status', {courseid: cfg.courseid})\n                .then((res) => {\n                    const count = res && typeof res.sessionscount === 'number' ? res.sessionscount : 0;\n                    renderTomatoes($('pomodoro-tomatoes'), count, cfg.longbreakInterval);\n                    return null;\n                })\n                .catch(Notification.exception);\n\n            // Resume (only if future)\n            const existingRaw = localStorage.getItem(K.END);\n            if (existingRaw !== null) {\n                const existing = Number(existingRaw);\n                const phase = getPhase();\n                let target;\n                if (phase === 'wellness') {\n                    target = $('wellness-countdown');\n                } else if (phase === 'break') {\n                    target = $('break-countdown');\n                } else {\n                    target = display;\n                }\n                if (Number.isFinite(existing) && existing > now() + 250) {\n                    if (phase === 'break') {\n                        openDialog($('break-modal'));\n                    }\n                    if (phase === 'wellness') {\n                        openDialog($('wellness-modal'));\n                    }\n                    startTimer(existing, target || display);\n                } else {\n                    localStorage.removeItem(K.END);\n                    localStorage.setItem(K.RUNNING, '0');\n                }\n            }\n\n            // Storage sync for this course key\n            window.addEventListener('storage', (e) => {\n                if (e.key === K.END) {\n                    if (e.newValue !== null) {\n                        const val = Number(e.newValue);\n                        if (Number.isFinite(val) && val > now() + 250) {\n                            startTimer(val, display);\n                        } else {\n                            localStorage.removeItem(K.END);\n                            localStorage.setItem(K.RUNNING, '0');\n                        }\n                    } else {\n                        localStorage.setItem(K.RUNNING, '0');\n                    }\n                    return;\n                }\n                if (e.key === K.MSG && e.newValue) {\n                    try {\n                        handleMessage(JSON.parse(e.newValue), display);\n                    } catch (err) {\n                        // Ignore malformed or transient values during storage sync\n                        if (window && window.console && typeof window.console.debug === 'function') {\n                            window.console.debug('Pomodoro: storage MSG parse ignored', err);\n                        }\n                    }\n                }\n            });\n\n            const startBtn = $('start');\n            if (startBtn) {\n                startBtn.type = 'button';\n                startBtn.onclick = (e) => {\n                    alarm('click');\n                    e.preventDefault();\n                    e.stopPropagation();\n                    startPausePomodoro(() => startFocus(display, cfg.focusMs));\n                };\n            }\n            const stopBtn = $('stop');\n            if (stopBtn) {\n                stopBtn.type = 'button';\n                stopBtn.onclick = (e) => {\n                    alarm('click');\n                    e.preventDefault();\n                    e.stopPropagation();\n                    stopAndReset(display, false);\n                };\n            }\n\n            window.addEventListener('beforeunload', () => {\n                if (channel) {\n                    channel.close();\n                }\n            });\n        }\n    };\n});\n"],"names":["define","Ajax","Notification","cfg","K","channel","intervalId","clearTick","clearInterval","alarm","kind","soundUrl","M","wwwroot","Audio","play","catch","navigator","vibrate","$","id","document","getElementById","now","Date","readInt","v","d","n","parseInt","Number","isFinite","formatTime","ms","s","Math","max","floor","m","toString","padStart","r","getTimerElement","renderTomatoes","el","sessionscount","interval","filled","innerHTML","Array","from","length","_","i","join","openDialog","showModal","closeDialog","open","close","startTimer","endTs","onDone","localStorage","removeItem","END","setItem","RUNNING","tick","left","textContent","sendMessage","type","setInterval","stopAndReset","triggerAlarm","focusMs","startPausePomodoro","onAfter","display","remainRaw","getItem","REMAINING","running","endRaw","String","remaining","setPhase","modal","countdown","end","wellnessSec","skip","onclick","e","preventDefault","stopPropagation","startWellness","remain","startFocus","focusDur","starttsSec","ajax","courseid","startts","then","res","count","longbreakInterval","isLong","c","dlg","cd","ok","startBreak","longbreakMs","shortbreakMs","exception","p","k","PHASE","BREAKKIND","msg","postMessage","MSG","JSON","stringify","Object","assign","t","setTimeout","handleMessage","name","args","call","methodname","init","timerDisplay","getAttribute","focusSec","NaN","focusMin","split","sbSec","lbSec","getConfig","cid","CHANNEL","scoped","intervalEl","BroadcastChannel","onmessage","data","existingRaw","existing","phase","target","window","addEventListener","key","newValue","parse","err","console","debug","val","startBtn","stopBtn"],"mappings":"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"}
>>>>>>> 19b9c1c (break working)
